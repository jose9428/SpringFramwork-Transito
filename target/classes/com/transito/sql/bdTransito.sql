USE master
IF EXISTS(SELECT * FROM sysdatabases WHERE name='bdtransito')
    begin
	DROP DATABASE bdtransito
	--GO
    end


CREATE DATABASE bdtransito
GO



USE bdtransito
GO


CREATE TABLE VEHICULO (
	NROPLA  char (6) NOT NULL primary key ,
	NOMPRO  char(35) NULL ,
	COLOR   varchar (15) NULL ,
	MODELO  VARCHAR(20) NULL
      ) 
GO


CREATE TABLE INFRACCION(
	INFCOD CHAR (3) NOT NULL primary key ,
	INFDES varchar (35) NULL ,
	INFIMP numeric (8, 1) NULL 
) 
GO


CREATE  table POLICIA(
	IDPOL char(4) NOT NULL Primary key ,
	NOMpol varchar (25) NULL ,
	NROPAT  CHAR(3) NULL 
	) 
GO

CREATE TABLE PAPELETA(
	NROPAP char (6) NOT NULL Primary Key ,
      NROPLA CHAR (6) NOT NULL,
	INFCOD char (3) NOT NULL ,
	IDPOL  CHAR (4) NULL ,
	PAPFECHA DATETIME NULL 
) 
go

INSERT INTO VEHICULO VALUES ('V00001','Acuña Osorio, Maria','ROJO','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00002','Avino Azaña,Britney','AZUL','HUNDAI' )
INSERT INTO VEHICULO VALUES ('V00003','Carpio SANCHEZ,Susana','ROJO','TERCEL' )
INSERT INTO VEHICULO VALUES ('V00004','ADELA MEZA, Mario','PLOMO','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00005','Bezada Obando, Mirlo','VERDE','TOYOTA' )
INSERT INTO VEHICULO VALUES ('V00006','Cabello Nieto,carlos','AZUL','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00007','Caycho Pino,Elizabeth','ROJO','HUNDAI' )
INSERT INTO VEHICULO VALUES ('V00008','Enciso VadeIglesias, Lorena','ROJO','TOYOTA' )
INSERT INTO VEHICULO VALUES ('V00009','Fernandez Porras ,Brain','ROJO','MITSUBICHE' )
INSERT INTO VEHICULO VALUES ('V00010','Rimari Barrientos ,Luis','ROJO','TERCEL' )
INSERT INTO VEHICULO VALUES ('V00011','Rojas ramos,Jose Luis','ROJO','TOYOTA')
INSERT INTO VEHICULO VALUES ('V00012','PAREDES Gonzales, Eduardo','ROJO','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00013','NURITH GUILLEN, Lucia','AZUL','DATSUN')
INSERT INTO VEHICULO VALUES ('V00014','VERGARA Lopez, Daniel','NEGRO','DATSUN')
INSERT INTO VEHICULO VALUES ('V00015','LOPEZ Costas, Marlo','NEGRO','HUNDAI' )
INSERT INTO VEHICULO VALUES ('V00016','huachua Lopez,Ernestina','AZUL','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00017','Cardenas Caceres,Juana','ROJO','DATSUN')
INSERT INTO VEHICULO VALUES ('V00018','Leon Malpartida, ana','AZUL','TOYOTA' )
INSERT INTO VEHICULO VALUES ('V00019','Gonzales carrillo, Mauricio','NEGRO','TERECEL' )

INSERT INTO VEHICULO VALUES ('V00020','Alarcon Brenda ,Luis','ROJO','TERCEL' )
INSERT INTO VEHICULO VALUES ('V00021','Artega Huaman, Patricia','ROJO','TOYOTA')
INSERT INTO VEHICULO VALUES ('V00022','Bustamente Ramirez, Eduardo','ROJO','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00023','Cespedes Urbano, Lucia','AZUL','DATSUN')
INSERT INTO VEHICULO VALUES ('V00024','Estrada Ponte, Lucy','NEGRO','DATSUN')
INSERT INTO VEHICULO VALUES ('V00025','Guzman Cruz, Eder','NEGRO','HUNDAI' )
INSERT INTO VEHICULO VALUES ('V00026','Ramos Perez,Erick','AZUL','DATSUN' )
INSERT INTO VEHICULO VALUES ('V00027','Rivera Custodio,Juan','ROJO','DATSUN')
INSERT INTO VEHICULO VALUES ('V00028','Robalino Ocmin, Jhony','AZUL','TOYOTA' )
INSERT INTO VEHICULO VALUES ('V00029','Santiago Trujillo, Homer','NEGRO','TERECEL' )
INSERT INTO VEHICULO VALUES ('V00030','Vilca Borchani, Isabel','NEGRO','TERECEL' )
INSERT INTO VEHICULO VALUES ('V00031','Cuipal Lopez, Marco','ROJO','DATSUN')






INSERT INTO POLICIA VALUES ('P001','Guzman Ochoa','007' )
INSERT INTO POLICIA VALUES ('P002','Maldonado Huaman','001' )
INSERT INTO POLICIA VALUES ('P003','Gaspar Acosta','004' )
INSERT INTO POLICIA VALUES ('P004','Echegaray Felix','007' )
INSERT INTO POLICIA VALUES ('P005','Cano Siu','004' )
INSERT INTO POLICIA VALUES ('P006','Melgarejo percy','001' )
INSERT INTO POLICIA VALUES ('P007','Grijalva Alan ','004' )
INSERT INTO POLICIA VALUES ('P008','Marin LOPEZ','007' )
INSERT INTO POLICIA VALUES ('P009','JOHANA LOPEZ','005' )


INSERT INTO INFRACCION VALUES ('I01','Luz Roja',90 )
INSERT INTO INFRACCION VALUES ('I02','Exceso de Velocidad',120 )
INSERT INTO INFRACCION VALUES ('I03','Sin Brevete',180 )
INSERT INTO INFRACCION VALUES ('I04','Mal Estacionado',80 )
INSERT INTO INFRACCION VALUES ('I05','Estado Etilico',200 )
INSERT INTO INFRACCION VALUES ('I06','Contra el Trafico',230 )
INSERT INTO INFRACCION VALUES ('I07','Sin semaforos',140 )
INSERT INTO INFRACCION VALUES ('I08','Contaminacion ambiental',125)




INSERT INTO PAPELETA VALUES ('100001','V00001','I08','P004','10/03/14')
INSERT INTO PAPELETA VALUES ('100002','V00001','I07','P001','05/03/14')
INSERT INTO PAPELETA VALUES ('100003','V00002','I06','P004','08/03/14')
INSERT INTO PAPELETA VALUES ('100004','V00003','I04','P005','09/05/14')
INSERT INTO PAPELETA VALUES ('100005','V00003','I04','P004','11/05/14')
INSERT INTO PAPELETA VALUES ('100006','V00003','I05','P006','12/05/14')
INSERT INTO PAPELETA VALUES ('100007','V00005','I04','P005','03/05/14')
INSERT INTO PAPELETA VALUES ('100008','V00005','I04','P001','04/06/14')
INSERT INTO PAPELETA VALUES ('100009','V00004','I08','P004','05/06/14')
INSERT INTO PAPELETA VALUES ('100010','V00004','I04','P004','08/06/14')
INSERT INTO PAPELETA VALUES ('100011','V00004','I04','P005','01/06/14')
INSERT INTO PAPELETA VALUES ('100012','V00004','I07','P004','02/06/14')
INSERT INTO PAPELETA VALUES ('100013','V00005','I08','P005','03/06/14')
INSERT INTO PAPELETA VALUES ('100014','V00005','I04','P004','04/06/14')
INSERT INTO PAPELETA VALUES ('100015','V00005','I01','P006','05/06/14')
INSERT INTO PAPELETA VALUES ('100016','V00005','I07','P006','08/06/14')
INSERT INTO PAPELETA VALUES ('100017','V00006','I05','P006','06/06/14')
INSERT INTO PAPELETA VALUES ('100018','V00006','I05','P001','07/06/14')
INSERT INTO PAPELETA VALUES ('100019','V00007','I05','P004','11/06/14')
INSERT INTO PAPELETA VALUES ('100020','V00007','I05','P001','02/06/14')

INSERT INTO PAPELETA VALUES ('100021','V00001','I05','P004','10/02/15')
INSERT INTO PAPELETA VALUES ('100022','V00011','I07','P001','05/02/15')
INSERT INTO PAPELETA VALUES ('100023','V00012','I08','P004','08/02/15')
INSERT INTO PAPELETA VALUES ('100024','V00012','I05','P005','09/03/15')
INSERT INTO PAPELETA VALUES ('100025','V00012','I04','P004','11/03/15')
INSERT INTO PAPELETA VALUES ('100026','V00013','I05','P006','12/05/15')
INSERT INTO PAPELETA VALUES ('100027','V00013','I05','P005','03/05/15')
INSERT INTO PAPELETA VALUES ('100028','V00013','I04','P001','04/05/15')
INSERT INTO PAPELETA VALUES ('100029','V00014','I07','P004','05/06/15')
INSERT INTO PAPELETA VALUES ('100030','V00014','I04','P004','08/06/15')
INSERT INTO PAPELETA VALUES ('100031','V00014','I04','P005','01/07/15')
INSERT INTO PAPELETA VALUES ('100032','V00014','I07','P004','02/07/15')
INSERT INTO PAPELETA VALUES ('100033','V00015','I04','P005','03/07/15')
INSERT INTO PAPELETA VALUES ('100034','V00016','I04','P004','04/07/15')
INSERT INTO PAPELETA VALUES ('100035','V00016','I01','P006','05/07/15')
INSERT INTO PAPELETA VALUES ('100036','V00017','I05','P006','08/07/15')
INSERT INTO PAPELETA VALUES ('100037','V00017','I05','P006','06/07/15')
INSERT INTO PAPELETA VALUES ('100038','V00018','I04','P001','07/07/15')
INSERT INTO PAPELETA VALUES ('100039','V00019','I04','P004','11/09/15')
INSERT INTO PAPELETA VALUES ('100040','V00019','I01','P001','02/10/06')

INSERT INTO PAPELETA VALUES ('100041','V00001','I05','P004','10/02/16')
INSERT INTO PAPELETA VALUES ('100042','V00011','I07','P001','05/02/16')
INSERT INTO PAPELETA VALUES ('100043','V00012','I08','P004','08/02/16')
INSERT INTO PAPELETA VALUES ('100044','V00012','I05','P005','09/03/16')
INSERT INTO PAPELETA VALUES ('100045','V00012','I04','P004','11/03/16')
INSERT INTO PAPELETA VALUES ('100046','V00013','I05','P006','12/05/16')
INSERT INTO PAPELETA VALUES ('100047','V00013','I05','P005','03/05/16')
INSERT INTO PAPELETA VALUES ('100048','V00013','I04','P001','04/05/16')
INSERT INTO PAPELETA VALUES ('100049','V00014','I07','P004','05/06/16')
INSERT INTO PAPELETA VALUES ('100050','V00014','I04','P004','08/06/16')
INSERT INTO PAPELETA VALUES ('100051','V00014','I04','P005','01/07/16')
INSERT INTO PAPELETA VALUES ('100052','V00014','I07','P004','02/07/16')
INSERT INTO PAPELETA VALUES ('100053','V00015','I04','P005','03/07/16')
INSERT INTO PAPELETA VALUES ('100054','V00016','I04','P004','04/07/16')
INSERT INTO PAPELETA VALUES ('100055','V00016','I01','P006','05/07/16')
INSERT INTO PAPELETA VALUES ('100056','V00017','I05','P006','08/07/16')
INSERT INTO PAPELETA VALUES ('100057','V00017','I05','P006','06/07/16')
INSERT INTO PAPELETA VALUES ('100058','V00018','I04','P001','07/07/16')
INSERT INTO PAPELETA VALUES ('100059','V00019','I04','P004','11/07/16')
INSERT INTO PAPELETA VALUES ('100060','V00019','I01','P001','02/07/16')

INSERT INTO PAPELETA VALUES ('100061','V00020','I05','P004','10/01/17')
INSERT INTO PAPELETA VALUES ('100062','V00020','I07','P001','05/01/17')
INSERT INTO PAPELETA VALUES ('100063','V00021','I08','P004','08/01/17')
INSERT INTO PAPELETA VALUES ('100064','V00021','I05','P005','09/01/17')
INSERT INTO PAPELETA VALUES ('100065','V00022','I04','P004','11/01/17')
INSERT INTO PAPELETA VALUES ('100066','V00022','I05','P006','12/02/17')
INSERT INTO PAPELETA VALUES ('100067','V00023','I05','P005','03/02/17')
INSERT INTO PAPELETA VALUES ('100068','V00023','I04','P001','04/02/17')
INSERT INTO PAPELETA VALUES ('100069','V00024','I07','P004','05/03/17')
INSERT INTO PAPELETA VALUES ('100070','V00024','I04','P004','08/03/17')
INSERT INTO PAPELETA VALUES ('100071','V00025','I04','P005','01/04/17')
INSERT INTO PAPELETA VALUES ('100072','V00025','I07','P004','02/04/17')
INSERT INTO PAPELETA VALUES ('100073','V00026','I04','P005','03/04/17')
INSERT INTO PAPELETA VALUES ('100074','V00026','I05','P004','04/05/17')
INSERT INTO PAPELETA VALUES ('100075','V00027','I01','P006','05/05/17')
INSERT INTO PAPELETA VALUES ('100076','V00027','I05','P006','08/05/17')
INSERT INTO PAPELETA VALUES ('100077','V00028','I05','P006','06/06/17')
INSERT INTO PAPELETA VALUES ('100078','V00028','I03','P001','07/06/17')
INSERT INTO PAPELETA VALUES ('100079','V00029','I03','P004','11/06/17')
INSERT INTO PAPELETA VALUES ('100080','V00029','I01','P001','02/06/17')
INSERT INTO PAPELETA VALUES ('100081','V00030','I03','P004','11/06/17')
INSERT INTO PAPELETA VALUES ('100082','V00030','I01','P001','02/06/17')

select * from papeleta

go

create procedure sp_reporte_mes(@anio int)
as
begin
 select MONTH(PAPFECHA) ,DATENAME(MONTH , PAPFECHA), count(*) , SUM(INFIMP)
 from PAPELETA P INNER JOIN INFRACCION I
 ON P.INFCOD = I.INFCOD
 where YEAR(PAPFECHA) in (@anio)
 group by MONTH(PAPFECHA) , DATENAME(MONTH , PAPFECHA)
 order by 1 asc
end
go


create procedure sp_reporte_propietario(@anio int)
as
begin
  select V.NROPLA , NOMPRO , COUNT(*) , SUM(INFIMP)
  from VEHICULO V INNER JOIN PAPELETA P
  on V.NROPLA = P.NROPLA
  INNER JOIN INFRACCION I
  ON I.INFCOD = p.INFCOD
  WHERE YEAR(PAPFECHA) IN (@anio)
  GROUP BY V.NROPLA , NOMPRO
end
go


exec sp_reporte_propietario 2015
go

execute sp_reporte_mes 2017
go